# Docker-compose setup for local development. This allows for a user
# to modify the Alfalfa worker code and run tests in the Docker
# container without needing to rebuild/restart Docker.
#
# Usage:
#   docker-compose -f docker-compose.yml -f docker-compose.dev.yml up --build

services:
  web: # main haystack application
    container_name: alfalfa_web
    build:
      # the purpose of context one level above dockerfile
      # is to utilize shared code, specifically in db
      dockerfile: alfalfa_web/Dockerfile
      context: .
      # The dev instance still needs works, so default to base for now
      target: dev
    environment:
      - NODE_ENV=development
    volumes:
      - ./alfalfa_web:/srv/alfalfa
      # create volumes for the build and node_modules so that
      # the resources are not copied back to the local host when
      # mounting.
      - /srv/alfalfa/build
      - /srv/alfalfa/node_modules
  worker:
    build:
      # the purpose of context one level above is to install the entire alfalfa package
      # and to copy the wait-for-it.sh and start_worker.sh files in the deploy directory
      dockerfile: alfalfa_worker/Dockerfile
      context: .
      target: dev
    volumes:
      - ./alfalfa_worker:/alfalfa/alfalfa_worker
      - ./tests:/alfalfa/tests
